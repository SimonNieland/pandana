<!doctype html>
<html lang="en">
<head>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.0.0/css/ol.css" type="text/css">
    <script src="http://openlayers.org/en/v3.0.0/build/ol.js" type="text/javascript"></script>
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <!--<script src="http://pathgl.com/dist/pathgl.js"></script>-->
    <title>Pandana Explorer</title>
</head>

<body>

<div id="map" style="width:100%; height:100%; position:fixed; left:0; top:0; overflow:hidden;"></div>

<script type="text/javascript">

    var key = 'Ak-dzM4wZjSqTlzveKz5u0d4IQ4bRzVI309GxmkgSVr1ewS6iPSrOvOKhA-CJlm3';

    var map = new ol.Map({
        layers: [
            new ol.layer.Tile({
                opacity: 1.0,
                source: new ol.source.BingMaps({
                    key: key,
                    imagerySet: 'Aerial'
                })
            })
        ],
        target: 'map',
        view: new ol.View({
            center: ol.proj.transform([-122.4191, 37.7792], 'EPSG:4326', 'EPSG:3857'),
            zoom: 12
        })
    });

    var buckets = 7;
    var colors = 'YlGnBu';
    var zoom_to_size = {
        10: 1,
        11: 1,
        12: 3,
        13: 5,
        14: 7,
        15: 8,
        16: 9,
        17: 10,
        18: 12
    }

    d3.csv("analysis.csv", function(d) {
        return {
            values:  +d.values,
            x:      +d.x,
            y:      +d.y
        };
    }, function(error, rows) {

        var canvasFunction = function(extent, resolution, pixelRatio,
                                      size, projection) {

            var canvasWidth = size[0];
            var canvasHeight = size[1];

            var canvas = d3.select(document.createElement('canvas'));
            canvas.attr('width', canvasWidth).attr('height', canvasHeight);

            var context = canvas.node().getContext('2d');

            x_scale = d3.scale.linear()
             .domain([extent[0], extent[2]])
             .range([0, canvasWidth]);
            y_scale = d3.scale.linear()
             .domain([extent[1], extent[3]])
             .range([canvasHeight, 0]);

            value_scale = d3.scale.quantile()
                    .domain(d3.extent(rows, function(r) {return r.values}))
                    .range(d3.range(buckets));

            rows.forEach(function(r) {

                if(r.x < extent[0] || r.x > extent[2] || r.y < extent[1] || r.y > extent[3])
                    return;

                var pixel = map.getPixelFromCoordinate([r.x, r.y]);
                pixel = [x_scale(r.x), y_scale(r.y)];

                var sz = zoom_to_size[map.getView().getZoom()];

                context.beginPath();
                context.arc(pixel[0], pixel[1], sz, 0, 2 * Math.PI, false);
                context.fillStyle = colorbrewer[colors][buckets][value_scale(r.values)];
                context.fill();

                /*canvas.append('circle')
                  .attr('r', 2)
                  .attr('cx', pixel[0])
                  .attr('cy', pixel[1])
                  .attr('fill', colorbrewer[colors][buckets][value_scale(r.values)]);
                */

            });

            return canvas[0][0];
        };

        var layer = new ol.layer.Image({
            source: new ol.source.ImageCanvas({
                canvasFunction: canvasFunction,
                projection: 'EPSG:3857'
            })
        });
        map.addLayer(layer);
    });

    var colorbrewer = {YlGn: {
        3: ["#f7fcb9","#addd8e","#31a354"],
        4: ["#ffffcc","#c2e699","#78c679","#238443"],
        5: ["#ffffcc","#c2e699","#78c679","#31a354","#006837"],
        6: ["#ffffcc","#d9f0a3","#addd8e","#78c679","#31a354","#006837"],
        7: ["#ffffcc","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#005a32"],
        8: ["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#005a32"],
        9: ["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"]
    },YlGnBu: {
        3: ["#edf8b1","#7fcdbb","#2c7fb8"],
        4: ["#ffffcc","#a1dab4","#41b6c4","#225ea8"],
        5: ["#ffffcc","#a1dab4","#41b6c4","#2c7fb8","#253494"],
        6: ["#ffffcc","#c7e9b4","#7fcdbb","#41b6c4","#2c7fb8","#253494"],
        7: ["#ffffcc","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#0c2c84"],
        8: ["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#0c2c84"],
        9: ["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"]
    }};

</script>
</body>
</html>